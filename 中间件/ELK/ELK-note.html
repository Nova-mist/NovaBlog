<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ELK | Nova Blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="我那摊大饼一样的零散学习笔记">
    
    <link rel="preload" href="/NovaBlog/assets/css/0.styles.26d8bde2.css" as="style"><link rel="preload" href="/NovaBlog/assets/js/app.7283b6f5.js" as="script"><link rel="preload" href="/NovaBlog/assets/js/2.6539ea43.js" as="script"><link rel="preload" href="/NovaBlog/assets/js/55.4577ea3a.js" as="script"><link rel="prefetch" href="/NovaBlog/assets/js/10.681f19e7.js"><link rel="prefetch" href="/NovaBlog/assets/js/11.adb3fca2.js"><link rel="prefetch" href="/NovaBlog/assets/js/12.e509a0f8.js"><link rel="prefetch" href="/NovaBlog/assets/js/13.0ace9699.js"><link rel="prefetch" href="/NovaBlog/assets/js/14.f11331b6.js"><link rel="prefetch" href="/NovaBlog/assets/js/15.c3fe2b37.js"><link rel="prefetch" href="/NovaBlog/assets/js/16.76473f3a.js"><link rel="prefetch" href="/NovaBlog/assets/js/17.1e6e96a7.js"><link rel="prefetch" href="/NovaBlog/assets/js/18.de0f476b.js"><link rel="prefetch" href="/NovaBlog/assets/js/19.464c0b71.js"><link rel="prefetch" href="/NovaBlog/assets/js/20.adc0ad6e.js"><link rel="prefetch" href="/NovaBlog/assets/js/21.a75102d0.js"><link rel="prefetch" href="/NovaBlog/assets/js/22.409ca266.js"><link rel="prefetch" href="/NovaBlog/assets/js/23.4b83f159.js"><link rel="prefetch" href="/NovaBlog/assets/js/24.b80958e2.js"><link rel="prefetch" href="/NovaBlog/assets/js/25.bbdd2bef.js"><link rel="prefetch" href="/NovaBlog/assets/js/26.0ed31014.js"><link rel="prefetch" href="/NovaBlog/assets/js/27.80bd39a6.js"><link rel="prefetch" href="/NovaBlog/assets/js/28.2772d3d5.js"><link rel="prefetch" href="/NovaBlog/assets/js/29.d14c59ce.js"><link rel="prefetch" href="/NovaBlog/assets/js/3.672c28f4.js"><link rel="prefetch" href="/NovaBlog/assets/js/30.3edde461.js"><link rel="prefetch" href="/NovaBlog/assets/js/31.da8777c1.js"><link rel="prefetch" href="/NovaBlog/assets/js/32.fa19d459.js"><link rel="prefetch" href="/NovaBlog/assets/js/33.2d3adc2b.js"><link rel="prefetch" href="/NovaBlog/assets/js/34.35850d01.js"><link rel="prefetch" href="/NovaBlog/assets/js/35.b14e62bb.js"><link rel="prefetch" href="/NovaBlog/assets/js/36.44753080.js"><link rel="prefetch" href="/NovaBlog/assets/js/37.8d2088d4.js"><link rel="prefetch" href="/NovaBlog/assets/js/38.4366f780.js"><link rel="prefetch" href="/NovaBlog/assets/js/39.c9f5137d.js"><link rel="prefetch" href="/NovaBlog/assets/js/4.854c56f8.js"><link rel="prefetch" href="/NovaBlog/assets/js/40.68c696f4.js"><link rel="prefetch" href="/NovaBlog/assets/js/41.7190c7b3.js"><link rel="prefetch" href="/NovaBlog/assets/js/42.7710aff4.js"><link rel="prefetch" href="/NovaBlog/assets/js/43.9f513289.js"><link rel="prefetch" href="/NovaBlog/assets/js/44.493f11ea.js"><link rel="prefetch" href="/NovaBlog/assets/js/45.66cd96d8.js"><link rel="prefetch" href="/NovaBlog/assets/js/46.f5e4e401.js"><link rel="prefetch" href="/NovaBlog/assets/js/47.c2f3caf8.js"><link rel="prefetch" href="/NovaBlog/assets/js/48.74afa3cf.js"><link rel="prefetch" href="/NovaBlog/assets/js/49.ea737da6.js"><link rel="prefetch" href="/NovaBlog/assets/js/5.f7ccee55.js"><link rel="prefetch" href="/NovaBlog/assets/js/50.3eca0141.js"><link rel="prefetch" href="/NovaBlog/assets/js/51.949ffca7.js"><link rel="prefetch" href="/NovaBlog/assets/js/52.d007ce86.js"><link rel="prefetch" href="/NovaBlog/assets/js/53.252a0d24.js"><link rel="prefetch" href="/NovaBlog/assets/js/54.97c86c53.js"><link rel="prefetch" href="/NovaBlog/assets/js/56.085a6c0d.js"><link rel="prefetch" href="/NovaBlog/assets/js/57.6804712d.js"><link rel="prefetch" href="/NovaBlog/assets/js/58.559b3cac.js"><link rel="prefetch" href="/NovaBlog/assets/js/59.48650730.js"><link rel="prefetch" href="/NovaBlog/assets/js/6.14027d31.js"><link rel="prefetch" href="/NovaBlog/assets/js/60.e53abbd4.js"><link rel="prefetch" href="/NovaBlog/assets/js/61.53d32451.js"><link rel="prefetch" href="/NovaBlog/assets/js/62.f93973c5.js"><link rel="prefetch" href="/NovaBlog/assets/js/63.9dd5b9b3.js"><link rel="prefetch" href="/NovaBlog/assets/js/64.4a1ac6da.js"><link rel="prefetch" href="/NovaBlog/assets/js/65.84f958d2.js"><link rel="prefetch" href="/NovaBlog/assets/js/66.38972cd8.js"><link rel="prefetch" href="/NovaBlog/assets/js/67.97df1d7d.js"><link rel="prefetch" href="/NovaBlog/assets/js/68.f78ccdc1.js"><link rel="prefetch" href="/NovaBlog/assets/js/69.9d476a9c.js"><link rel="prefetch" href="/NovaBlog/assets/js/7.5c5bd089.js"><link rel="prefetch" href="/NovaBlog/assets/js/70.28382d01.js"><link rel="prefetch" href="/NovaBlog/assets/js/71.4a4fdf3a.js"><link rel="prefetch" href="/NovaBlog/assets/js/72.646ad1ce.js"><link rel="prefetch" href="/NovaBlog/assets/js/73.2f2ebeb1.js"><link rel="prefetch" href="/NovaBlog/assets/js/74.22b83718.js"><link rel="prefetch" href="/NovaBlog/assets/js/75.50e2585a.js"><link rel="prefetch" href="/NovaBlog/assets/js/76.998e5fbe.js"><link rel="prefetch" href="/NovaBlog/assets/js/77.e805e4a0.js"><link rel="prefetch" href="/NovaBlog/assets/js/8.f20fe421.js"><link rel="prefetch" href="/NovaBlog/assets/js/9.749c610b.js">
    <link rel="stylesheet" href="/NovaBlog/assets/css/0.styles.26d8bde2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/NovaBlog/" class="home-link router-link-active"><!----> <span class="site-name">Nova Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/NovaBlog/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NovaBlog/Java/Mybatis/" class="nav-link">
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/Java/Spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/Java/SpringBoot/" class="nav-link">
  Spring Boot
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/Java/SpringMVC/" class="nav-link">
  Spring MVC
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/Java/基础/" class="nav-link">
  基础
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tools" class="dropdown-title"><span class="title">Tools</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tools" class="mobile-dropdown-title"><span class="title">Tools</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NovaBlog/Tools/Git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/Tools/接口/" class="nav-link">
  接口
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/Tools/日志&amp;json/" class="nav-link">
  日志&amp;json
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/Tools/部署/" class="nav-link">
  部署
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="web" class="dropdown-title"><span class="title">web</span> <span class="arrow down"></span></button> <button type="button" aria-label="web" class="mobile-dropdown-title"><span class="title">web</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NovaBlog/web/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/web/基础/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/web/状态管理/" class="nav-link">
  状态管理
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/web/组件库/" class="nav-link">
  组件库
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/web/路由/" class="nav-link">
  路由
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件" class="mobile-dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NovaBlog/中间件/ELK/" class="nav-link">
  ELK
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NovaBlog/数据库/MySQL/" class="nav-link">
  My SQL
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/数据库/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法" class="mobile-dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NovaBlog/算法/其他/" class="nav-link">
  其他
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/算法/动规/" class="nav-link">
  动规
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/算法/贪心/" class="nav-link">
  贪心
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/算法/链表二叉树/" class="nav-link">
  链表二叉树
</a></li></ul></div></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/NovaBlog/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NovaBlog/Java/Mybatis/" class="nav-link">
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/Java/Spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/Java/SpringBoot/" class="nav-link">
  Spring Boot
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/Java/SpringMVC/" class="nav-link">
  Spring MVC
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/Java/基础/" class="nav-link">
  基础
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tools" class="dropdown-title"><span class="title">Tools</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tools" class="mobile-dropdown-title"><span class="title">Tools</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NovaBlog/Tools/Git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/Tools/接口/" class="nav-link">
  接口
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/Tools/日志&amp;json/" class="nav-link">
  日志&amp;json
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/Tools/部署/" class="nav-link">
  部署
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="web" class="dropdown-title"><span class="title">web</span> <span class="arrow down"></span></button> <button type="button" aria-label="web" class="mobile-dropdown-title"><span class="title">web</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NovaBlog/web/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/web/基础/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/web/状态管理/" class="nav-link">
  状态管理
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/web/组件库/" class="nav-link">
  组件库
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/web/路由/" class="nav-link">
  路由
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件" class="mobile-dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NovaBlog/中间件/ELK/" class="nav-link">
  ELK
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NovaBlog/数据库/MySQL/" class="nav-link">
  My SQL
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/数据库/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法" class="mobile-dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NovaBlog/算法/其他/" class="nav-link">
  其他
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/算法/动规/" class="nav-link">
  动规
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/算法/贪心/" class="nav-link">
  贪心
</a></li><li class="dropdown-item"><!----> <a href="/NovaBlog/算法/链表二叉树/" class="nav-link">
  链表二叉树
</a></li></ul></div></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ELK</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/NovaBlog/%E4%B8%AD%E9%97%B4%E4%BB%B6/ELK/" aria-current="page" class="sidebar-link">ELK</a></li><li><a href="/NovaBlog/中间件/ELK/ELK-note.html" class="active sidebar-link">ELK</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#概念" class="sidebar-link">概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#全文索引" class="sidebar-link">全文索引</a></li></ul></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#文档入门" class="sidebar-link">文档入门</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#默认自带字段解析" class="sidebar-link">默认自带字段解析</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#文档-id" class="sidebar-link">文档 id</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#定制返回-source-字段" class="sidebar-link">定制返回 _source 字段</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#文档替换与删除" class="sidebar-link">文档替换与删除</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#局部替换" class="sidebar-link">局部替换</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#内置脚本" class="sidebar-link">内置脚本</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#并发" class="sidebar-link">并发</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#使用版本号" class="sidebar-link">使用版本号</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#批量操作" class="sidebar-link">批量操作</a></li></ul></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#整合-springboot" class="sidebar-link">整合 SpringBoot</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#mapping-映射" class="sidebar-link">Mapping 映射</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#mapping-概念" class="sidebar-link">mapping 概念</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#精准匹配与全文检索" class="sidebar-link">精准匹配与全文检索</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#建立倒排索引" class="sidebar-link">建立倒排索引</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#分词器-analyzer" class="sidebar-link">分词器 analyzer</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#mapping-数据类型" class="sidebar-link">mapping 数据类型</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#手动管理-mapping" class="sidebar-link">手动管理 mapping</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#复杂数据类型" class="sidebar-link">复杂数据类型</a></li></ul></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#索引" class="sidebar-link">索引</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#管理索引" class="sidebar-link">管理索引</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#type-底层结构和弃用原因" class="sidebar-link">type 底层结构和弃用原因</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#定制-dynamic-mapping" class="sidebar-link">定制 dynamic mapping</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#零停机重建索引" class="sidebar-link">零停机重建索引</a></li></ul></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#分词器" class="sidebar-link">分词器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#定制分词器" class="sidebar-link">定制分词器</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#中文分词器" class="sidebar-link">中文分词器</a></li></ul></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#java-api-索引管理" class="sidebar-link">java api 索引管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#新增索引" class="sidebar-link">新增索引</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#删除索引-2" class="sidebar-link">删除索引</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#索引信息" class="sidebar-link">索引信息</a></li></ul></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#搜索" class="sidebar-link">搜索</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#搜索语法" class="sidebar-link">搜索语法</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#多索引搜索" class="sidebar-link">多索引搜索</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#分页搜索" class="sidebar-link">分页搜索</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#query-dsl" class="sidebar-link">query DSL</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#全文检索" class="sidebar-link">全文检索</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#filter" class="sidebar-link">Filter</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#验证查询计划" class="sidebar-link">验证查询计划</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#定制排序规则" class="sidebar-link">定制排序规则</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#text-字段排序" class="sidebar-link">Text 字段排序</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#scroll-分批查询" class="sidebar-link">Scroll 分批查询</a></li></ul></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#java-api-搜索" class="sidebar-link">java api 搜索</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#普通搜索" class="sidebar-link">普通搜索</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#分页搜索-2" class="sidebar-link">分页搜索</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#id-搜索" class="sidebar-link">ID 搜索</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#match-搜索" class="sidebar-link">match 搜索</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#关键词搜索" class="sidebar-link">关键词搜索</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#bool-搜索" class="sidebar-link">bool 搜索</a></li></ul></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#聚合" class="sidebar-link">聚合</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#使用示例" class="sidebar-link">使用示例</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#概念-2" class="sidebar-link">概念</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#聚合案例" class="sidebar-link">聚合案例</a></li></ul></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#java-api-聚合" class="sidebar-link">java api 聚合</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#es7-sql" class="sidebar-link">es7 sql</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#logstash" class="sidebar-link">Logstash</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#基础" class="sidebar-link">基础</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#读取-nginx-日志" class="sidebar-link">读取 nginx 日志</a></li></ul></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#kibana" class="sidebar-link">Kibana</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#集群部署" class="sidebar-link">集群部署</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#todo-8-4-java-api" class="sidebar-link">TODO：8.4 java api</a></li><li class="sidebar-sub-header"><a href="/NovaBlog/中间件/ELK/ELK-note.html#todo-项目实战" class="sidebar-link">TODO：项目实战</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="elk"><a href="#elk" class="header-anchor">#</a> ELK</h1> <h2 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h2> <h3 id="全文索引"><a href="#全文索引" class="header-anchor">#</a> 全文索引</h3> <div class="language-mysql extra-class"><pre class="language-text"><code># 单表搜索
select * from product where content like '%哪吒%';

# 全文检索
select * from product_term where term = '哪吒';
</code></pre></div><p>存入数据之后立刻对其进行分词，建立<strong>倒排索引</strong>的表。</p> <p><img src="https://cdn.jsdelivr.net/gh/Nova-mist/HexoBlogResources/images/2022/202210121842197.png" alt="image-20221012184154383"></p> <h4 id="elasticsearch核心概念-vs-数据库核心概念"><a href="#elasticsearch核心概念-vs-数据库核心概念" class="header-anchor">#</a> elasticsearch核心概念 vs. 数据库核心概念</h4> <table><thead><tr><th><strong>关系型数据库（比如Mysql）</strong></th> <th><strong>非关系型数据库（Elasticsearch）</strong></th></tr></thead> <tbody><tr><td>数据库Database</td> <td>索引Index</td></tr> <tr><td>表Table</td> <td>索引Index（原为Type）</td></tr> <tr><td>数据行Row</td> <td>文档Document</td></tr> <tr><td>数据列Column</td> <td>字段Field</td></tr> <tr><td>约束 Schema</td> <td>映射Mapping</td></tr></tbody></table> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <p>✅方法一：正常安装在 windows 上，点击 bat 文件启动 elasticsearch 和 kibana</p> <p>方法二：使用 docker 容器</p> <blockquote><p>8.X 初步体验：需要新建 docker 网络，并且直接运行容器，kibana 和 elasticsearch 之间需要登录认证，并且 postman 也用不了。</p> <p>需要更改 wsl 内存上限，否则无法运行容器。</p> <p>有通过 <code>docker-compose.yaml</code> 的方法来一键运行集群</p> <p>运行容器的时候控制台会输出 token ，没看到就要进入容器中再生成</p> <p>目录 /usr/share/elasticsearch</p></blockquote> <p><strong>原因竟然是自动开启了安全功能</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/Nova-mist/HexoBlogResources/images/2022/202210122225312.png" alt="image-20221012222553541"></p> <blockquote><p>Name: <code>elastic</code> PWD：TeDxP5x+rq<em>kKsbH</em>U2V</p> <p>HTTP : c89766fc47d1582478eddab48d62b5ab8aac63ebf6276c1201fb99bd375a5724</p> <p>token: eyJ2ZXIiOiI4LjQuMyIsImFkciI6WyIxNzIuMjAuMTEyLjE6OTIwMCJdLCJmZ3IiOiJjODk3NjZmYzQ3ZDE1ODI0NzhlZGRhYjQ4ZDYyYj
VhYjhhYWM2M2ViZjYyNzZjMTIwMWZiOTliZDM3NWE1NzI0Iiwia2V5IjoiN24tT3pJTUJrbE9yRWtwZ1RVTTU6a28tSERndnlUeS1POWR6UV
ljSHFfdyJ9</p></blockquote> <p><strong>设置 Postman</strong></p> <p>参考：<a href="https://blog.csdn.net/FlyLikeButterfly/article/details/125165771" target="_blank" rel="noopener noreferrer">ES——使用Postman连接Elasticsearch_FlyLikeButterfly的博客-CSDN博客_postman请求es<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ol><li>要设置 Authorization 的用户名和密码</li> <li>添加 Content-Type 为 application/json 类型</li> <li>添加 ca 证书</li> <li><strong>请求要改为 HTTPS</strong></li></ol> <h2 id="文档入门"><a href="#文档入门" class="header-anchor">#</a> 文档入门</h2> <h3 id="默认自带字段解析"><a href="#默认自带字段解析" class="header-anchor">#</a> 默认自带字段解析</h3> <p>不同的数据放在不同的索引中</p> <p><img src="https://cdn.jsdelivr.net/gh/Nova-mist/HexoBlogResources/images/2022/202210130024638.png" alt="image-20221013002359085"></p> <h3 id="文档-id"><a href="#文档-id" class="header-anchor">#</a> 文档 id</h3> <ol><li><p>手动输入 id
数据从其他系统导入时，本身有唯一主键（id）。如数据库中的图书、员工信息等</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /test_index/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;test_field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>使用 GUID 算法自动生成 id。分布式生成不冲突</p> <div class="language-json extra-class"><pre class="language-json"><code>POST /test_index/_doc
<span class="token punctuation">{</span>
  <span class="token property">&quot;test_field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test1&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>返回20长度字符，URL安全，base64 编码。</p></li></ol> <h3 id="定制返回-source-字段"><a href="#定制返回-source-字段" class="header-anchor">#</a> 定制返回 _source 字段</h3> <div class="language- extra-class"><pre class="language-text"><code>GET /book/_doc/2?_source_includes=name,price
</code></pre></div><h3 id="文档替换与删除"><a href="#文档替换与删除" class="header-anchor">#</a> 文档替换与删除</h3> <ul><li><p>使用 PUT 更新文档，<code>_version</code> 会增加。
旧文档的内容<strong>不会立即删除</strong>，只是标记为deleted。适当的时机，集群会将这些文档删除。</p></li> <li><p><strong>只能新建</strong>，如果已有就会报错，这样可以防止数据被覆盖</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /test_index/_create/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;test_field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="局部替换"><a href="#局部替换" class="header-anchor">#</a> 局部替换</h3> <p>使用 <code>PUT /index/type/id</code> 为文档全量替换</p> <p>局部替换只修改变动字段</p> <div class="language-json extra-class"><pre class="language-json"><code>POST /book/_update/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;微信小程序开发&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>内部与全量替换是一样的，旧文档标记为删除，新建一个文档。</p> <h3 id="内置脚本"><a href="#内置脚本" class="header-anchor">#</a> 内置脚本</h3> <ol><li><p>修改文档6的num字段，+1</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /test_index/_doc/<span class="token number">6</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;num&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 更新脚本</span>
POST /test_index/_update/<span class="token number">6</span>
<span class="token punctuation">{</span>
   <span class="token property">&quot;script&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ctx._source.num+=1&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查询数据</span>
GET /test_index/_doc/<span class="token number">6</span>
</code></pre></div></li> <li><p>搜索所有文档，将num字段乘以2输出</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /test_index/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;script_fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;my_doubled_field&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token property">&quot;lang&quot;</span><span class="token operator">:</span> <span class="token string">&quot;expression&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;doc['num'] * multiplier&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;multiplier&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="并发"><a href="#并发" class="header-anchor">#</a> 并发</h3> <p><img src="https://cdn.jsdelivr.net/gh/Nova-mist/HexoBlogResources/images/2022/202210131022279.png" alt="image-20221013102254870"></p> <ul><li>悲观锁：每次只有一个线程能够操作数据，并发能力弱。</li> <li>乐观锁：只通过每次对比版本号来控制修改，高并发的情况下，重复次数多，并发能力强。</li></ul> <p><strong>es对于文档的增删改都是基于版本号</strong></p> <p>es内部主从同步时，是多线程异步。乐观锁机制。</p> <ul><li>基于版本控制</li> <li>会丢弃旧版本的请求</li></ul> <h3 id="使用版本号"><a href="#使用版本号" class="header-anchor">#</a> 使用版本号</h3> <div class="language-json extra-class"><pre class="language-json"><code>PUT /test_index/_doc/<span class="token number">5</span>?version=<span class="token number">1</span>

<span class="token comment">// 外部版本号</span>
PUT /test_index/_doc/<span class="token number">4</span>?version=<span class="token number">2</span>&amp;version_type=external

<span class="token comment">// 重试次数</span>
POST /test_index/_doc/<span class="token number">5</span>/_update?retry_on_conflict=<span class="token number">3</span>&amp;version=<span class="token number">22</span>&amp;version_type=external
</code></pre></div><h3 id="批量操作"><a href="#批量操作" class="header-anchor">#</a> 批量操作</h3> <ul><li><p>批量查询</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// 同一个索引下可以省略 _index</span>
GET /_mget
<span class="token punctuation">{</span>
   <span class="token property">&quot;docs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
         <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;book&quot;</span><span class="token punctuation">,</span>
         <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span>    <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
         <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_index&quot;</span><span class="token punctuation">,</span>
         <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span>    <span class="token number">6</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 也可使用muti search api 注意格式最后要空一行 不能格式化</span>
GET /book/_msearch
<span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;match_all&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

</code></pre></div></li> <li><p>批量增删改查 bulk
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html" target="_blank" rel="noopener noreferrer">Bulk API | Elasticsearch Guide<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// 注意格式最后要空一行 不能格式化</span>
POST _bulk
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;field1&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;value1&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;delete&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;3&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;field1&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;value3&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;update&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;doc&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;field2&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;value2&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>

GET /test/_msearch
<span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;match_all&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

</code></pre></div></li></ul> <h2 id="整合-springboot"><a href="#整合-springboot" class="header-anchor">#</a> 整合 SpringBoot</h2> <p><a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/current/introduction.html" target="_blank" rel="noopener noreferrer">Introduction | Elasticsearch Java API Client<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>Features</strong></p> <ol><li>强类型的请求和响应</li> <li>异步和同步的 api 版本</li> <li>使用 JSON 格式，方便整合应用</li> <li>将协议处理委托给http客户端</li></ol> <h2 id="mapping-映射"><a href="#mapping-映射" class="header-anchor">#</a> Mapping 映射</h2> <h3 id="mapping-概念"><a href="#mapping-概念" class="header-anchor">#</a> mapping 概念</h3> <blockquote><p>自动或手动为index中的_doc建立的一种数据结构和相关配置，简称为mapping映射。</p> <p>类似于 mysql 的建表语句，但 elasticsearch 是动态映射，自动设置数据类型和分词方法。</p></blockquote> <p>获取 mapping</p> <div class="language-json extra-class"><pre class="language-json"><code>GET book/_mapping
</code></pre></div><p><strong>定制化搜索</strong></p> <div class="language-json extra-class"><pre class="language-json"><code>GET book/_search?q=微信 <span class="token comment">// 在所有field中搜索</span>
GET book/_search?q=<span class="token string">&quot;微信小程序&quot;</span>
GET book/_search?q=price<span class="token operator">:</span><span class="token number">38.6</span> <span class="token comment">// 指定field</span>
</code></pre></div><blockquote><p>es自动建立mapping的时候，设置了不同的field不同的data type。不同的data type的<strong>分词、搜索</strong>等行为是不一样的。所以出现了_all field和post_date field的搜索表现完全不一样。</p></blockquote> <h3 id="精准匹配与全文检索"><a href="#精准匹配与全文检索" class="header-anchor">#</a> 精准匹配与全文检索</h3> <ol><li>精准匹配：<code>select * from book where name = 'java'</code></li> <li>全文检索：<strong>支持缩写、格式转换、大小写、同义词、分词</strong></li></ol> <h3 id="建立倒排索引"><a href="#建立倒排索引" class="header-anchor">#</a> 建立倒排索引</h3> <ol><li>分词</li> <li>normalization 规则化，<code>mum &lt;-&gt; mother</code></li> <li>建立倒排索引</li></ol> <p>搜索的时候也会分词和规则化。</p> <h3 id="分词器-analyzer"><a href="#分词器-analyzer" class="header-anchor">#</a> 分词器 analyzer</h3> <p>组成：</p> <ul><li>character filter：预处理文本，过滤 html 标签、转换符号</li> <li>tokenizer：分词</li> <li>token filter：处理大小写、无实意的介词助词、规则化（dogs &lt;-&gt; dog）</li></ul> <p>分类：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-analyzers.html" target="_blank" rel="noopener noreferrer">Built-in analyzer reference | Elasticsearch Guide<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ol><li>Standard analyzer：使用 unicode 分割算法，分割 <code>-</code> 不分割 <code>'</code>，全部变小写。</li> <li>Simple analyzer：遇到非字母就分割，数字、空格、<code>-</code>、<code>'</code>，全部变为小写。</li> <li>Whitespace analyzer：只分割空格，不做其他处理。</li> <li>等等。</li></ol> <p>分词策略：</p> <ul><li><code>date</code> 精确匹配</li> <li><code>text</code> 全文检索</li></ul> <p><strong>测试分词器</strong></p> <div class="language-json extra-class"><pre class="language-json"><code>GET /_analyze
<span class="token punctuation">{</span>
  <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;standard&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;text&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Text to analyze 80&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>token 实际存储的term 关键字</p> <p>position 在此词条在原文本中的位置</p> <p>start_offset/end_offset字符在原始字符串中的位置</p></blockquote> <h3 id="mapping-数据类型"><a href="#mapping-数据类型" class="header-anchor">#</a> mapping 数据类型</h3> <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html" target="_blank" rel="noopener noreferrer">Field data types | Elasticsearch Guide<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>dates、numbers、object、version、text</p> <p>类型推测 dynamic mapping</p> <p><strong>查看 mapping</strong></p> <div class="language-json extra-class"><pre class="language-json"><code>GET book/_mapping

<span class="token comment">// 所有es索引的映射</span>
GET _mapping
</code></pre></div><h3 id="手动管理-mapping"><a href="#手动管理-mapping" class="header-anchor">#</a> 手动管理 mapping</h3> <h4 id="创建映射"><a href="#创建映射" class="header-anchor">#</a> 创建映射</h4> <p>在创建索引后 <strong>手动创建</strong>映射</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT book2

<span class="token comment">// 设置</span>
PUT book2/_mapping
<span class="token punctuation">{</span>
	<span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
           <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
           <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span><span class="token string">&quot;english&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span><span class="token string">&quot;english&quot;</span>
           <span class="token punctuation">}</span><span class="token punctuation">,</span>
           <span class="token property">&quot;pic&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
             <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
             <span class="token property">&quot;index&quot;</span><span class="token operator">:</span><span class="token boolean">false</span>
           <span class="token punctuation">}</span><span class="token punctuation">,</span>
           <span class="token property">&quot;studymodel&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
             <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span>
           <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>analyzer 指定分词器</p></li> <li><p>search_analyzer 搜索时的分词器</p></li> <li><p>index 属性是否索引，例如图片地址不需要搜索就设置为 false，创建时默认为 true，所以需要<strong>删除索引</strong>并在重新创建时<strong>显式指定</strong></p></li> <li><p>❓store：是否在 <code>_source</code> 再存储一份文档</p></li> <li><p>可以设置关键词 <code>keyword</code> 字段，不进行分词按照整体检索，如手机号、身份证。keyword字段通常用于过虑、排序、聚合等。</p></li> <li><p>日期类型不用设置分词器。通常日期类型的字段用于排序。
<strong>可以指定日期格式</strong></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// 只能在原有基础上新增，无法更新</span>
PUT /book2/_mapping
<span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;date&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

PUT /book2/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Bootstrap开发框架&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span><span class="token string">&quot;Bootstrap是由Twitter推出的一个前台页面开发框架，在行业之中使用较为广泛。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长页面开发的程序人员）轻松的实现一个不受浏览器限制的精美界面效果。&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;pic&quot;</span><span class="token operator">:</span><span class="token string">&quot;group1/M00/00/01/wKhlQFqO4MmAOP53AAAcwDwm6SU490.jpg&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;studymodel&quot;</span><span class="token operator">:</span><span class="token string">&quot;201002&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span><span class="token string">&quot;2021-10-13 18:28:58&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p>数值类型的设置</p> <ol><li><p>选择范围小的类型，提高检索效率。</p></li> <li><p>浮点数使用比例因子，整型比浮点型更j节省空间</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// 输入的价格是23.45则ES中会将23.45乘以100存储在ES中</span>
<span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scaled_float&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;scaling_factor&quot;</span><span class="token operator">:</span> <span class="token number">100</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div></li></ol> <h4 id="修改映射"><a href="#修改映射" class="header-anchor">#</a> 修改映射</h4> <p>🟠只能新增索引再重新创建映射，不能更新（涉及数据太多），会报错。</p> <p>但可以新增字段。</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /book2/_mapping/
<span class="token punctuation">{</span>
  <span class="token property">&quot;properties&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;new_field&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span>    <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
     <span class="token property">&quot;index&quot;</span><span class="token operator">:</span>    <span class="token string">&quot;false&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="删除映射"><a href="#删除映射" class="header-anchor">#</a> 删除映射</h4> <p>删除索引也就删除了映射。</p> <h3 id="复杂数据类型"><a href="#复杂数据类型" class="header-anchor">#</a> 复杂数据类型</h3> <ul><li><p>数组类型，每个 item 类型要一样。</p></li> <li><p>空数组</p></li> <li><p>对象</p></li></ul> <div class="language-json extra-class"><pre class="language-json"><code>PUT /company/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;country&quot;</span><span class="token operator">:</span> <span class="token string">&quot;china&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;province&quot;</span><span class="token operator">:</span> <span class="token string">&quot;guangdong&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;city&quot;</span><span class="token operator">:</span> <span class="token string">&quot;guangzhou&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jack&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token number">27</span><span class="token punctuation">,</span>
    <span class="token property">&quot;join_date&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2019-01-01&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;tag1&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;tag2&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;null_tag&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;null_tag_array&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;null_tag_array2&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token null keyword">null</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查询</span>
GET /company/_doc/<span class="token number">1</span>
<span class="token comment">// 查看映射，没有空值的映射</span>
GET /company/_mappings
</code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/Nova-mist/HexoBlogResources/images/2022/202210140012322.png" alt="image-20221014001141078"></p> <h2 id="索引"><a href="#索引" class="header-anchor">#</a> 索引</h2> <h3 id="管理索引"><a href="#管理索引" class="header-anchor">#</a> 管理索引</h3> <blockquote><p>直接put数据 PUT index/_doc/1,es会自动生成索引，并建立动态映射dynamic mapping。</p> <p>在生产上，我们需要自己手动建立索引和映射，为了更好地管理索引。就像数据库的建表语句一样。</p></blockquote> <h4 id="创建索引"><a href="#创建索引" class="header-anchor">#</a> 创建索引</h4> <ol><li>设置</li> <li>映射</li> <li>别名</li></ol> <div class="language-json extra-class"><pre class="language-json"><code>PUT /index
<span class="token punctuation">{</span>
    <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> ... any settings ... <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token property">&quot;properties&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field1&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;aliases&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    	<span class="token property">&quot;default_index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>🌰：创建索引、插入数据、查询索引</p> <p><img src="https://cdn.jsdelivr.net/gh/Nova-mist/HexoBlogResources/images/2022/202210140020371.png" alt="image-20221014002007038"></p> <h4 id="修改索引"><a href="#修改索引" class="header-anchor">#</a> 修改索引</h4> <div class="language-json extra-class"><pre class="language-json"><code>PUT /my_index/_settings
<span class="token punctuation">{</span>
    <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;number_of_replicas&quot;</span> <span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="删除索引"><a href="#删除索引" class="header-anchor">#</a> 删除索引</h4> <div class="language-json extra-class"><pre class="language-json"><code>DELETE /my_index

DELETE /index_one<span class="token punctuation">,</span>index_two

DELETE /index_*
</code></pre></div><p>🔴删除全部索引 <code>DELETE /_all</code></p> <p>可以修改 <code>elasticsearch.yml</code>，设置 <code>action.destructive_requires_name: true</code> 来禁用此功能。</p> <h3 id="type-底层结构和弃用原因"><a href="#type-底层结构和弃用原因" class="header-anchor">#</a> type 底层结构和弃用原因</h3> <p><code>PUT my_index/_doc/1</code></p> <p>在上面的语句中 <code>_doc</code> 就是 type 字段，一个索引可以有多个 type，每个 type 中又有多个数据字段。</p> <p>但在底层 lucence 中没有 type 的概念，所以 es 是将 type 作为文档的一个字段储存。</p> <p>es 文档的底层存储：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
   <span class="token property">&quot;goods&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;false&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span>
        <span class="token punctuation">}</span>
        <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;double&quot;</span>
        <span class="token punctuation">}</span>
        <span class="token property">&quot;service_period&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;eat_period&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同一索引下，不同type的数据存储其他type的field 大量空值，造成资源浪费。</p> <p>es9中会删除 type，<strong>不同类型的数据放到不同的索引中</strong></p> <h3 id="定制-dynamic-mapping"><a href="#定制-dynamic-mapping" class="header-anchor">#</a> 定制 dynamic mapping</h3> <p>遇到新的字段时，映射的建立策略。</p> <h4 id="是否自动映射"><a href="#是否自动映射" class="header-anchor">#</a> 是否自动映射</h4> <p>可以在创建 mapping 指定 <code>dynamic</code> 属性：</p> <ul><li>true 自动映射</li> <li>false 插入数据，但不建立映射，于是无法搜索该字段（不在倒排索引表中），但是可以在<strong>搜索其他字段</strong>时关联出现</li> <li>strict 遇到新的字段就报错</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// false</span>
PUT /my_index
<span class="token punctuation">{</span>
    <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;dynamic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">,</span>
       <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;dynamic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;true&quot;</span>
        <span class="token punctuation">}</span>
	    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 插入值</span>
PUT /my_index/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my article&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;this is my article&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;province&quot;</span><span class="token operator">:</span> <span class="token string">&quot;guangdong&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;city&quot;</span><span class="token operator">:</span> <span class="token string">&quot;guangzhou&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取不到字段</span>
GET /my_index/_mapping

<span class="token comment">// 但可以搜索其他字段被关联出来</span>
GET /my_index/_search?q=guangdong
</code></pre></div><h4 id="映射策略"><a href="#映射策略" class="header-anchor">#</a> 映射策略</h4> <p>es 会根据传入的值推断类型</p> <ul><li><strong>日期检测</strong>：默认按照一定格式识别 date，可以手动关闭 <code>date_detection</code> ，日期会被推断为 String 类型，需要的时候显式指定某个字段为 date 类型。</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>PUT /my_index
<span class="token punctuation">{</span>
    <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;date_detection&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
       <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;dynamic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;true&quot;</span>
        <span class="token punctuation">}</span>
	    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 插入</span>
PUT /my_index/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my article&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;this is my article&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;province&quot;</span><span class="token operator">:</span> <span class="token string">&quot;guangdong&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;city&quot;</span><span class="token operator">:</span> <span class="token string">&quot;guangzhou&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;post_date&quot;</span><span class="token operator">:</span><span class="token string">&quot;2019-09-10&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查看映射</span>
GET /my_index/_mapping
</code></pre></div><p>可以设置日期检测的格式：</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT my_index
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dynamic_date_formats&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;MM/dd/yyyy&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 插入数据</span>
PUT my_index/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;create_date&quot;</span><span class="token operator">:</span> <span class="token string">&quot;09/25/2019&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 只有符合此格式才会被推断为date类型</span>
<span class="token comment">// 如果第一次插入2019-09-25，字段类型就固定为了String，再插入09/25/2018也是String</span>
<span class="token comment">// 如果第一次插入09/25/2019，字段类型就固定为了date，再插入2018-09-25会报错</span>
GET /my_index/_mapping
</code></pre></div><ul><li><strong>数字检测</strong>：默认情况下禁用，将字符串映射为浮点或整数类型。</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>PUT my_index
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;numeric_detection&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
PUT my_index/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;my_float&quot;</span><span class="token operator">:</span>   <span class="token string">&quot;1.0&quot;</span><span class="token punctuation">,</span> 
  <span class="token property">&quot;my_integer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span> 
<span class="token punctuation">}</span>
</code></pre></div><h4 id="映射模板"><a href="#映射模板" class="header-anchor">#</a> 映射模板</h4> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// 插入文档的key名匹配 + value类型匹配 -&gt; 映射为text类型并使用english分词器</span>
PUT /my_index
<span class="token punctuation">{</span>
    <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;dynamic_templates&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span> 
                  <span class="token property">&quot;en&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                      <span class="token property">&quot;match&quot;</span><span class="token operator">:</span>              <span class="token string">&quot;*_en&quot;</span><span class="token punctuation">,</span> 
                      <span class="token property">&quot;match_mapping_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
                      <span class="token property">&quot;mapping&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span>           <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
                          <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span>       <span class="token string">&quot;english&quot;</span>
                      <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>                  
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 插入数据</span>
PUT /my_index/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;this is my first article&quot;</span>
<span class="token punctuation">}</span>

PUT /my_index/_doc/<span class="token number">2</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;title_en&quot;</span><span class="token operator">:</span> <span class="token string">&quot;this is my first article&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试搜索</span>
GET my_index/_search?q=first
GET my_index/_search?q=is
</code></pre></div><p>搜索 <code>first</code> 两条内容都可以查到，搜索 <code>is</code> 只能查到一条内容，因为在插如 <code>_doc/2</code> 的时候匹配到了自定义的映射模板，应用了 english 分词器，于是 <code>is</code> 作为停顿词被过滤掉了。</p> <p>用来匹配的插入属性的模板参数，也可以使用<strong>正则表达式</strong>。</p> <div class="language- extra-class"><pre class="language-text"><code>&quot;match&quot;:   &quot;long_*&quot;,
&quot;unmatch&quot;: &quot;*_text&quot;,
&quot;match_mapping_type&quot;: &quot;string&quot;,
&quot;path_match&quot;:   &quot;name.*&quot;,
&quot;path_unmatch&quot;: &quot;*.middle&quot;,
</code></pre></div><p>🟢应用：</p> <ol><li><p>将 string 映射为 keyword，只使用精确搜索、对字段运行聚合排序，不进行分词。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;strings_as_keywords&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;match_mapping_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;mapping&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></li> <li><p>只使用全文搜索功能，不进行排序或精确搜索，可以映射为 text</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;strings_as_text&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;match_mapping_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;mapping&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>禁用排序用的评分因子，从而节省存储空间。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;strings_as_keywords&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;match_mapping_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;mapping&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;norms&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;keyword&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;ignore_above&quot;</span><span class="token operator">:</span> <span class="token number">256</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="零停机重建索引"><a href="#零停机重建索引" class="header-anchor">#</a> 零停机重建索引</h3> <h4 id="原理-使用-alias"><a href="#原理-使用-alias" class="header-anchor">#</a> 原理 —— 使用 alias</h4> <p>在生产实践中，Java 程序请求的应当是一个<strong>索引别名</strong>，这样在切换索引时程序是无感知的。</p> <ol><li><p>设置索引别名</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /my_index_v1/_alias/my_index
</code></pre></div></li> <li><p>在重建索引后切换索引别名</p> <div class="language-json extra-class"><pre class="language-json"><code>POST /_aliases
<span class="token punctuation">{</span>
    <span class="token property">&quot;actions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">&quot;remove&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my_index_v1&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;alias&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my_index&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">&quot;add&quot;</span><span class="token operator">:</span>    <span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my_index_v2&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;alias&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my_index&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h4 id="重建索引流程"><a href="#重建索引流程" class="header-anchor">#</a> 重建索引流程</h4> <blockquote><p>场景：</p> <ol><li>索引的字段无法修改，只能按照新的mapping重建创建索引，然后将数据批量导入</li> <li>例如插入 <em>2019-09-10</em> 字符串会被自动映射为日期格式，后续插入其他字符串的时候会报错，只能重建索引。</li> <li>查询数据的时候是多线程并发，中途重建索引会导致 Java 程序为了更换索引名而停机。</li></ol></blockquote> <p>报错案例</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /my_index/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2019-09-10&quot;</span>
<span class="token punctuation">}</span>

PUT /my_index/_doc/<span class="token number">2</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2019-09-11&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 已经被映射成了date类型 插入字符串报错</span>
PUT /my_index/_doc/<span class="token number">3</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my first article&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 修改title类型会报错</span>
PUT /my_index/_mapping
<span class="token punctuation">{</span>
  <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
   	<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>正确流程</strong></p> <ol><li>创建索引的时候指定别名，Java 程序使用索引别名查询。</li> <li>使用新的 mapping 选项重建索引</li> <li>使用 scroll api 批量查询旧的索引，使用 bulk api 将结果批量写入新索引（反复循环几轮）</li> <li>将 prod_index_alias 切换到新的索引上，对于 Java 程序来说是无缝切换的</li></ol> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// 只添加alias是不需要删除索引的</span>
PUT /my_index/_alias/prod_index

<span class="token comment">// 重建索引</span>
PUT /my_index_new
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查询</span>
GET /my_index/_search?scroll=1m
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>    
    <span class="token property">&quot;size&quot;</span><span class="token operator">:</span>  <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token comment">// 插入到新的索引</span>
POST /_bulk
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span>  <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my_index_new&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;title&quot;</span><span class="token operator">:</span>    <span class="token string">&quot;2019-09-10&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span>  <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my_index_new&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;title&quot;</span><span class="token operator">:</span>    <span class="token string">&quot;2019-08-09&quot;</span> <span class="token punctuation">}</span>

<span class="token comment">// 操作别名</span>
POST /_aliases
<span class="token punctuation">{</span>
    <span class="token property">&quot;actions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">&quot;remove&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my_index&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;alias&quot;</span><span class="token operator">:</span> <span class="token string">&quot;prod_index&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">&quot;add&quot;</span><span class="token operator">:</span>    <span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my_index_new&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;alias&quot;</span><span class="token operator">:</span> <span class="token string">&quot;prod_index&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

GET /prod_index/_search
</code></pre></div><h2 id="分词器"><a href="#分词器" class="header-anchor">#</a> 分词器</h2> <h3 id="定制分词器"><a href="#定制分词器" class="header-anchor">#</a> 定制分词器</h3> <ul><li>过滤英语停用词，the、a、is...</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// 创建分词器</span>
PUT /my_index
<span class="token punctuation">{</span>
  <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;analysis&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;es_std&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 名字</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;standard&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;stopwords&quot;</span><span class="token operator">:</span> <span class="token string">&quot;_english_&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试分词器</span>
GET /my_index/_analyze
<span class="token punctuation">{</span>
  <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;standard&quot;</span><span class="token punctuation">,</span> 
  <span class="token property">&quot;text&quot;</span><span class="token operator">:</span> <span class="token string">&quot;a dog is in the house&quot;</span>
<span class="token punctuation">}</span>

GET /my_index/_analyze
<span class="token punctuation">{</span>
  <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;es_std&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;text&quot;</span><span class="token operator">:</span><span class="token string">&quot;a dog is in the house&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>定制分词器
<ol><li>定义字符 filter，映射字符 <code>&amp;=&gt; and</code></li> <li>定义停用词 filter，过滤 <code>the</code> / <code>a</code></li> <li>自定义分词器，设置字符 filter、分词器类型、通用 filter。</li></ol></li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// 创建</span>
PUT /my_index
<span class="token punctuation">{</span>
  <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;analysis&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;char_filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;&amp;_to_and&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mapping&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&amp;=&gt; and&quot;</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;my_stopwords&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stop&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;stopwords&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;the&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;my_analyzer&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;custom&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;char_filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;html_strip&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&amp;_to_and&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">&quot;tokenizer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;standard&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;lowercase&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;my_stopwords&quot;</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试</span>
GET /my_index/_analyze
<span class="token punctuation">{</span>
  <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my_analyzer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;text&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tom&amp;jerry are a friend in the house, &lt;img&gt;, HAHA!!&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 设置字段使用自定义分词器</span>
PUT /my_index/_mapping/
<span class="token punctuation">{</span>
  <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my_analyzer&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="中文分词器"><a href="#中文分词器" class="header-anchor">#</a> 中文分词器</h3> <h4 id="安装与使用"><a href="#安装与使用" class="header-anchor">#</a> 安装与使用</h4> <div class="language-json extra-class"><pre class="language-json"><code>GET /_analyze
<span class="token punctuation">{</span>
  <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;standard&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;text&quot;</span><span class="token operator">:</span> <span class="token string">&quot;中华人民共和国人民大会堂&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>需要效果：中华人民共和国，人民大会堂</p> <p>✅使用插件 <a href="https://github.com/medcl/elasticsearch-analysis-ik" target="_blank" rel="noopener noreferrer">IK 分词器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>根据es版本下载相应版本包并解压到 <code>es/plugins/ik中</code>。（插件版本一定要与es版本相同；目录下面就是文件）</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /_analyze
<span class="token punctuation">{</span>
  <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;text&quot;</span><span class="token operator">:</span> <span class="token string">&quot;中华人民共和国人民大会堂&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>ik_max_word: 会将文本做最细粒度的拆分</li> <li>ik_smart: 会做最粗粒度的拆分</li></ul> <p><strong>存储时指定分词器</strong></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// 创建索引</span>
PUT /my_index
<span class="token punctuation">{</span>
    <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;text&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 插入</span>
PUT /my_index/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;中华人民共和国大会堂&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 检索</span>
GET /my_index/_search?q=人
GET /my_index/_search?q=中华
</code></pre></div><h4 id="ik-配置文件"><a href="#ik-配置文件" class="header-anchor">#</a> ik 配置文件</h4> <ul><li><code>IKAnalyzer.cfg.xml</code> 配置文件，可以扩展字典和停止词字典，支持远程配置。</li> <li><code>main.dic</code> 中文词库</li> <li><code>*.dic</code> 介词、量词等字典</li></ul> <p>自定义建立词库：<code>IKAnalyzer.cfg.xml</code> -》<code>my.dic</code></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ext_dict<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>my.dic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="词库热更新"><a href="#词库热更新" class="header-anchor">#</a> 词库热更新</h4> <p>手动添加词库的不便：</p> <ol><li>更新词库后需要重启 es</li> <li>es 分布式的</li></ol> <p>方法一：提供 http 接口给 ik 分词器，会自动更新词库。</p> <p>方法二：修改源码，手动支持从 mysql 中定时自动加载新词库。</p> <p>==TODO：修改源码==</p> <p><a href="https://www.bilibili.com/video/BV1hf4y1E7FD?p=53" target="_blank" rel="noopener noreferrer">参考视频<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ol><li>创建自定义线程，在循环中重新加载词典</li> <li>新增加载 mysql 词典的方法（使用 jdbc 驱动）</li> <li>config 目录下新建 <code>jdbc-reload.properties</code> 配置文件</li> <li>mvn package 打包后替换原 jar 包</li> <li>将 jdbc 依赖放到 lib 目录</li></ol> <h2 id="java-api-索引管理"><a href="#java-api-索引管理" class="header-anchor">#</a> java api 索引管理</h2> <h3 id="新增索引"><a href="#新增索引" class="header-anchor">#</a> 新增索引</h3> <ul><li><strong>创建请求</strong></li> <li>设置参数</li> <li>指定映射
<ul><li>文本</li> <li>Map 键值对</li> <li>XContentBuilder</li></ul></li> <li>设置别名</li> <li>额外参数</li> <li><strong>执行操作</strong></li> <li><strong>获取结果</strong></li></ul> <p>异步新增：设置监听方法。</p> <h3 id="删除索引-2"><a href="#删除索引-2" class="header-anchor">#</a> 删除索引</h3> <ul><li>创建操作对象</li> <li>操作索引的客户端</li> <li>执行删除索引操作</li> <li>得到响应</li></ul> <p>异步删除：设置监听方法。</p> <h3 id="索引信息"><a href="#索引信息" class="header-anchor">#</a> 索引信息</h3> <ol><li>索引是否存在</li> <li>关闭索引</li> <li>开启索引</li></ol> <h2 id="搜索"><a href="#搜索" class="header-anchor">#</a> 搜索</h2> <h3 id="搜索语法"><a href="#搜索语法" class="header-anchor">#</a> 搜索语法</h3> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// 默认搜索全部</span>
GET /book/_search
</code></pre></div><p>took：耗费了几毫秒</p> <p>timed_out：是否超时，这里是没有</p> <p>_shards：到几个分片搜索，成功几个，跳过几个，失败几个。</p> <p>hits.total：查询结果的数量，3个document</p> <p>hits.max_score：score的含义，就是document对于一个search的相关度的匹配分数，越相关，就越匹配，分数也高</p> <p>hits.hits：包含了匹配搜索的document的所有详细数据</p> <p><strong>传参</strong></p> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search?q=name<span class="token operator">:</span>java&amp;sort=price<span class="token operator">:</span>desc
</code></pre></div><p>类似于 sql 的 <code>select * from book where name like '%java%' order by price desc</code></p> <p><strong>包含语法</strong></p> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search?q=name<span class="token operator">:</span>java

GET /book/_search?q=+name<span class="token operator">:</span>java

GET /book/_search?q=-name<span class="token operator">:</span>java
</code></pre></div><p><strong>直接搜索所有 field</strong></p> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search?q=java
</code></pre></div><p>并不是遍历每个 field，而是去 <code>_all</code> 字段中寻找。建立索引时 es 会将所有的分词保存一份副本放到 <code>_all</code> 字段中。</p> <p><strong>设置超时时间及时返回结果</strong></p> <p>10ms 内能查到多少就返回多少</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search?timeout=10ms
</code></pre></div><p>全局设置：配置文件中设置 search.default_search_timeout：100ms。默认不超时。</p> <p><img src="https://cdn.jsdelivr.net/gh/Nova-mist/HexoBlogResources/images/2022/202210151402242.png" alt="image-20221015140158932"></p> <h3 id="多索引搜索"><a href="#多索引搜索" class="header-anchor">#</a> 多索引搜索</h3> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// 检索两个索引</span>
GET /book<span class="token punctuation">,</span>book2/_search
</code></pre></div><p>语法：</p> <div class="language- extra-class"><pre class="language-text"><code>/_search：所有索引下的所有数据都搜索出来
/index1/_search：指定一个index，搜索其下所有的数据
/index1,index2/_search：同时搜索两个index下的数据
/index*/_search：按照通配符去匹配多个索引
</code></pre></div><p>实际应用：检索生产环境中的日志</p> <p>log_to_es_20190910</p> <p>log_to_es_20190911</p> <p>log_to_es_20180910</p> <p><strong>搜索图解</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/Nova-mist/HexoBlogResources/images/2022/202210151410577.png" alt="image-20221015141003604"></p> <h3 id="分页搜索"><a href="#分页搜索" class="header-anchor">#</a> 分页搜索</h3> <p>类似 sql 的 <code>select * from book limit 1,5</code></p> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search?size=<span class="token number">10</span>

GET /book/_search?size=<span class="token number">10</span>&amp;from=<span class="token number">0</span>

GET /book/_search?size=<span class="token number">10</span>&amp;from=<span class="token number">20</span>

GET /book_search?from=<span class="token number">0</span>&amp;size=<span class="token number">3</span>
</code></pre></div><p><strong>避免 deep paging</strong></p> <p>根据相关度评分倒排序，所以分页过深，协调节点会将大量数据聚合分析。</p> <p>会占用大量带宽、内存、cpu</p> <p><img src="https://cdn.jsdelivr.net/gh/Nova-mist/HexoBlogResources/images/2022/202210151432689.png" alt="image-20221015143207145"></p> <h3 id="query-dsl"><a href="#query-dsl" class="header-anchor">#</a> query DSL</h3> <p>es 特有的搜索语法，可以在 GET 的请求体中携带搜索条件。</p> <ul><li>查询全部 GET /book/_search</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>排序 GET /book/_search?sort=price:desc</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search 
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;match&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot; java&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>multi_match</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;multi_match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;java程序员&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;description&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>范围查询</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;gte&quot;</span><span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
		<span class="token property">&quot;lte&quot;</span><span class="token operator">:</span> <span class="token number">90</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>分页查询 GET /book/_search?size=10&amp;from=0</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET  /book/_search 
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre></div><p>指定返回字段 GET /book/ _search? _source=name,studymodel</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search 
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_source&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;studymodel&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>关键词搜索</strong>，不会分词</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;java程序员&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET /book/_search
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;search&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;full_text&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;nosql&quot;</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>存在字段</strong></li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET /_search
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;exists&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;join_date&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>根据 id 查询</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;ids&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;values&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;100&quot;</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>根据前缀查询字段</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;prefix&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;spring&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>正则查询</strong></li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;regexp&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;j.*a&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;flags&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ALL&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;max_determinized_states&quot;</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
                <span class="token property">&quot;rewrite&quot;</span><span class="token operator">:</span> <span class="token string">&quot;constant_score&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>🍄模糊查询，适用于：换个字符、多个/少个字符、相邻字符调换顺序。但是查出的结果 <code>_score</code> 评分很低。</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;fuzzy&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jave&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>通过组合构建复杂的检索语句</strong></p> <p>与或非，可以内层嵌套</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// 插入</span>
POST /website/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
          <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my hadoop article&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hadoop is very bad&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;author_id&quot;</span><span class="token operator">:</span> <span class="token number">111</span>
<span class="token punctuation">}</span>

POST /website/_doc/<span class="token number">2</span>
<span class="token punctuation">{</span>
          <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my elasticsearch  article&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;es is very bad&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;author_id&quot;</span><span class="token operator">:</span> <span class="token number">112</span>
<span class="token punctuation">}</span>
POST /website/_doc/<span class="token number">3</span>
<span class="token punctuation">{</span>
          <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my elasticsearch article&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;es is very goods&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;author_id&quot;</span><span class="token operator">:</span> <span class="token number">111</span>
<span class="token punctuation">}</span>

<span class="token comment">// 搜索</span>
GET /website/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;elasticsearch&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;should&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;elasticsearch&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;must_not&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;author_id&quot;</span><span class="token operator">:</span> <span class="token number">111</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="全文检索"><a href="#全文检索" class="header-anchor">#</a> 全文检索</h3> <p>创建索引</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /book/
<span class="token punctuation">{</span>
  <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;number_of_shards&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;number_of_replicas&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;studymodel&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;price&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;double&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;date&quot;</span><span class="token punctuation">,</span>
         <span class="token property">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;pic&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span><span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>插入数据</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /book/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Bootstrap开发&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;studymodel&quot;</span><span class="token operator">:</span> <span class="token string">&quot;201002&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;price&quot;</span><span class="token operator">:</span><span class="token number">38.6</span><span class="token punctuation">,</span>
<span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span><span class="token string">&quot;2019-08-25 19:11:35&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;pic&quot;</span><span class="token operator">:</span><span class="token string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;bootstrap&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dev&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

PUT /book/_doc/<span class="token number">2</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;java编程思想&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;studymodel&quot;</span><span class="token operator">:</span> <span class="token string">&quot;201001&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;price&quot;</span><span class="token operator">:</span><span class="token number">68.6</span><span class="token punctuation">,</span>
<span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span><span class="token string">&quot;2019-08-25 19:11:35&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;pic&quot;</span><span class="token operator">:</span><span class="token string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;java&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dev&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

PUT /book/_doc/<span class="token number">3</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;spring开发基础&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;spring 在java领域非常流行，java程序员都在用。&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;studymodel&quot;</span><span class="token operator">:</span> <span class="token string">&quot;201001&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;price&quot;</span><span class="token operator">:</span><span class="token number">88.6</span><span class="token punctuation">,</span>
<span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span><span class="token string">&quot;2019-08-24 19:11:35&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;pic&quot;</span><span class="token operator">:</span><span class="token string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;spring&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;java&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>搜索，省略了 <code>bool:{}</code></p> <div class="language-json extra-class"><pre class="language-json"><code>GET  /book/_search 
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;match&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;description&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;java程序员&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>返回结果默认按照 <code>_score</code> 反应的分词匹配度来排序。</p> <h3 id="filter"><a href="#filter" class="header-anchor">#</a> Filter</h3> <ul><li>filter，只有条件过滤的功能，不影响相关度分数</li> <li>写在 query 中的 match，会计算相对于搜索条件的相关度，<strong>分数影响排序</strong></li></ul> <blockquote><p>应用场景：</p> <p>使用 query 获取根据匹配分数排序的搜索结果</p> <p>使用 filter 筛选出符合条件的结果，经常搭配 query 使用</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;java程序员&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 新增条件会影响分数</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;gte&quot;</span><span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
		      <span class="token property">&quot;lte&quot;</span><span class="token operator">:</span> <span class="token number">90</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 正确用法 只是用于过滤结果</span>
GET /book/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;java程序员&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;gte&quot;</span><span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
		     <span class="token property">&quot;lte&quot;</span><span class="token operator">:</span> <span class="token number">90</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="验证查询计划"><a href="#验证查询计划" class="header-anchor">#</a> 验证查询计划</h3> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_validate/query?explain
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;mach&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 此处报错</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;java程序员&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>适用于复杂的搜索，在使用之前可以先验证语法。</p> <p>explain 类似 mysql 的执行计划，可以看到搜索的目标信息。</p> <h3 id="定制排序规则"><a href="#定制排序规则" class="header-anchor">#</a> 定制排序规则</h3> <p>默认按照 <code>_score</code> 降序排序</p> <p>使用 <code>sort</code> 字段定制排序</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// method1</span>
GET /book/_search 
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;constant_score&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 不影响评分</span>
            <span class="token property">&quot;filter&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;term&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;studymodel&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;201001&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token string">&quot;asc&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// method2</span>
GET /book/_search 
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;studymodel&quot;</span><span class="token operator">:</span> <span class="token string">&quot;201001&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token string">&quot;asc&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="text-字段排序"><a href="#text-字段排序" class="header-anchor">#</a> Text 字段排序</h3> <p>因为 text 字段会进行分词存入倒排索引表，es 无法获取真实值用来排序，于是会报错。</p> <p>方法一：创建索引时，指定 text 类型映射 <code>fielddata: true</code>，按照第一个分词来排序。</p> <p>✅可以将一个text field建立两次索引，一个分词，用来进行搜索；一个不分词，用来进行排序</p> <p><img src="https://cdn.jsdelivr.net/gh/Nova-mist/HexoBlogResources/images/2022/202210151625372.png" alt="image-20221015162508942"></p> <p><img src="https://cdn.jsdelivr.net/gh/Nova-mist/HexoBlogResources/images/2022/202210151625637.png" alt="image-20221015162523639"></p> <h3 id="scroll-分批查询"><a href="#scroll-分批查询" class="header-anchor">#</a> Scroll 分批查询</h3> <blockquote><p>适用于查询数据过多的情况，一次查出内存会溢出，所以需要一批一批查询。</p> <p>scoll搜索会在第一次搜索的时候，保存一个当时的视图快照，之后只会基于该旧的视图快照提供数据搜索</p></blockquote> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search?scroll=1m <span class="token comment">// 每次查询的时间</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token comment">// 每次查询条数</span>
<span class="token punctuation">}</span>
</code></pre></div><p>会返回第一次查询的结构，含有 <code>scroll_id</code></p> <p><strong>继续查询</strong></p> <div class="language-json extra-class"><pre class="language-json"><code>GET /_search/scroll
<span class="token punctuation">{</span>
    <span class="token property">&quot;scroll&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1m&quot;</span><span class="token punctuation">,</span> 
    <span class="token property">&quot;scroll_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAMOkWTURBNDUtcjZTVUdKMFp5cXloVElOQQ==&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>应用场景：批量下载数据、数据转移、零停机重建索引</p> <h2 id="java-api-搜索"><a href="#java-api-搜索" class="header-anchor">#</a> java api 搜索</h2> <h3 id="普通搜索"><a href="#普通搜索" class="header-anchor">#</a> 普通搜索</h3> <ol><li>构建搜索请求（可以排除字段）</li> <li>执行搜索</li> <li>获取结果（getHits）</li></ol> <h3 id="分页搜索-2"><a href="#分页搜索-2" class="header-anchor">#</a> 分页搜索</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//第几页</span>
<span class="token keyword">int</span> page<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//每页几个</span>
<span class="token keyword">int</span> size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment">//下标计算</span>
<span class="token keyword">int</span> from<span class="token operator">=</span><span class="token punctuation">(</span>page<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>size<span class="token punctuation">;</span>


searchSourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>
searchSourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="id-搜索"><a href="#id-搜索" class="header-anchor">#</a> ID 搜索</h3> <div class="language-java extra-class"><pre class="language-java"><code>searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">idsQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIds</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="match-搜索"><a href="#match-搜索" class="header-anchor">#</a> match 搜索</h3> <div class="language-java extra-class"><pre class="language-java"><code>searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;description&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;java程序员&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;java程序员&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;description&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="关键词搜索"><a href="#关键词搜索" class="header-anchor">#</a> 关键词搜索</h3> <div class="language-java extra-class"><pre class="language-java"><code>searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;description&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;java程序员&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="bool-搜索"><a href="#bool-搜索" class="header-anchor">#</a> bool 搜索</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//构建multiMatch请求</span>
<span class="token class-name">MultiMatchQueryBuilder</span> multiMatchQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;java程序员&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;description&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//构建match请求</span>
<span class="token class-name">MatchQueryBuilder</span> matchQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;studymodel&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;201001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 与或非</span>
<span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder<span class="token operator">=</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>multiMatchQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
boolQueryBuilder<span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span>matchQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// filter</span>
boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 排序</span>
searchSourceBuilder<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">ASC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="聚合"><a href="#聚合" class="header-anchor">#</a> 聚合</h2> <h3 id="使用示例"><a href="#使用示例" class="header-anchor">#</a> 使用示例</h3> <ul><li>计算每个 keyword 的成员数量</li></ul> <p>类似 sql <code>select studymodel，count(*) from book group by studymodel</code></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 不返回具体内容</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;group_by_studymodel&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;studymodel&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>计算每个 tags 【数组】 的成员数量</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// 设置映射 fielddata:true</span>
PUT /book/_mapping/
<span class="token punctuation">{</span>
  <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;fielddata&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// tags是数组</span>
GET /book/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> 
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;group_by_tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tags&quot;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 加上搜索条件</span>
<span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;java程序员&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> 
</code></pre></div><ul><li>计算分组平均值</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET /book/_search
<span class="token punctuation">{</span>
    <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;aggs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;group_by_tags&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;terms&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> 
              <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;tags&quot;</span><span class="token punctuation">,</span>
              <span class="token comment">// 排序</span>
              <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;avg_price&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">// 子聚合</span>
            <span class="token property">&quot;aggs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;avg_price&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 求平均</span>
                    <span class="token property">&quot;avg&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;price&quot;</span> <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>按照价格区间分组，再组内按照 tag 分组，最后计算每组 tag 的平均值，<strong>组内降序</strong>。</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 自定义名字</span>
        <span class="token property">&quot;range_by_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// 区间选项</span>
            <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;ranges&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span>
                        <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;to&quot;</span><span class="token operator">:</span> <span class="token number">40</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{</span>
                        <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">40</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;to&quot;</span><span class="token operator">:</span> <span class="token number">60</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{</span>
                        <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;to&quot;</span><span class="token operator">:</span> <span class="token number">80</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;group_by_tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tags&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                            <span class="token property">&quot;avg_price&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;avg_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                            <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                                <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="概念-2"><a href="#概念-2" class="header-anchor">#</a> 概念</h3> <ul><li><code>bucket</code> 数据分组，类似于 sql 的 <code>group by</code></li> <li><code>metric</code> 对数据分组进行的操作，类似于 sql 的 <code>avg()</code> 、<code>sum()</code> 、<code>count(*)</code></li></ul> <h3 id="聚合案例"><a href="#聚合案例" class="header-anchor">#</a> 聚合案例</h3> <p>创建索引和映射、插入数据</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /tvs
<span class="token punctuation">{</span>
    <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;color&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;brand&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;sold_date&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;date&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>批量插入数据</p> <div class="language-json extra-class"><pre class="language-json"><code>POST /tvs/_bulk
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token property">&quot;color&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;红色&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;brand&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;长虹&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;sold_date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2019-10-28&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token property">&quot;color&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;红色&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;brand&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;长虹&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;sold_date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2019-11-05&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token property">&quot;color&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;绿色&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;brand&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;小米&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;sold_date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2019-05-18&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token number">1500</span><span class="token punctuation">,</span> <span class="token property">&quot;color&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;蓝色&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;brand&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;TCL&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;sold_date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2019-07-02&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token number">1200</span><span class="token punctuation">,</span> <span class="token property">&quot;color&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;绿色&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;brand&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;TCL&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;sold_date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2019-08-19&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token property">&quot;color&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;红色&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;brand&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;长虹&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;sold_date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2019-11-05&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token number">8000</span><span class="token punctuation">,</span> <span class="token property">&quot;color&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;红色&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;brand&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;三星&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;sold_date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2020-01-01&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token number">2500</span><span class="token punctuation">,</span> <span class="token property">&quot;color&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;蓝色&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;brand&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;小米&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;sold_date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2020-02-12&quot;</span> <span class="token punctuation">}</span>

</code></pre></div><p>测试搜索</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /tvs/_mapping

<span class="token comment">// 全部数据</span>
GET /tvs/_search
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>需求1：统计哪种颜色的电视销量最高</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET /tvs/_search
<span class="token punctuation">{</span>
    <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 不获取聚合的原始数据</span>
    <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;popular_colors&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 根据字段分组</span>
                <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_count&quot;</span><span class="token operator">:</span> <span class="token string">&quot;asc&quot;</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html#_ordering_by_count_ascending" target="_blank" rel="noopener noreferrer">Terms aggregation | Elasticsearch Guide<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>需求2：统计分钟颜色电视平均价格</li></ul> <p>相当于 sql <code>select avg(price) from tvs group by color</code></p> <div class="language-json extra-class"><pre class="language-json"><code>GET /tvs/_search
<span class="token punctuation">{</span>
   <span class="token property">&quot;size&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
   <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;colors&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;avg_price&quot;</span><span class="token operator">:</span> <span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
            <span class="token property">&quot;avg_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
               <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                  <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span> 
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>需求3：每个颜色下的平均价格和每个颜色下每个品牌的平均价格</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET /tvs/_search 

<span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;group_by_color&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;color&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;color_avg_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;group_by_brand&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brand&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;brand_avg_price&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;brand_avg_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>需求4：metrir 操作，每个颜色的平均、最小、最大、求和</li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET /tvs/_search
<span class="token punctuation">{</span>
   <span class="token property">&quot;size&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
   <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;colors&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;color&quot;</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;avg_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;min_price&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;min&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
            <span class="token property">&quot;max_price&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;max&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;sum_price&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;sum&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> 
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>需求5：按照某个字段的范围区间来进行分组</li></ul> <p>自动将 price 字段按照 2000 的间隔来分组</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /tvs/_search
<span class="token punctuation">{</span>
   <span class="token property">&quot;size&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
   <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token property">&quot;price&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
         <span class="token property">&quot;histogram&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span> 
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;interval&quot;</span><span class="token operator">:</span> <span class="token number">2000</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">&quot;income&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
               <span class="token property">&quot;sum&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
                 <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
               <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>需求6：按照日期分组聚合
<ul><li><code>min_doc_count</code>：对于日期分组聚合，默认过滤掉没有数据的分组，使用 <code>min_doc_count</code> 设定保留分组的最小值，设为0就是显示所有分组</li> <li>extended_bounds，min，max：划分分组的起始和终止范围</li></ul></li></ul> <div class="language-json extra-class"><pre class="language-json"><code>GET /tvs/_search
<span class="token punctuation">{</span>
   <span class="token property">&quot;size&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
   <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;sales&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token property">&quot;date_histogram&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sold_date&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;calendar_interval&quot;</span><span class="token operator">:</span> <span class="token string">&quot;month&quot;</span><span class="token punctuation">,</span> 
            <span class="token property">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;min_doc_count&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> 
            <span class="token property">&quot;extended_bounds&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> 
                <span class="token property">&quot;min&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2019-01-01&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;max&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2020-12-31&quot;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>需求7：统计每季度每个品牌的销售额</li></ul> <p>分了季度、品牌、总额三个分组</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;group_by_sold_date&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;date_histogram&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sold_date&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;calendar_interval&quot;</span><span class="token operator">:</span> <span class="token string">&quot;quarter&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;extended_bounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;min&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2019-01-01&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;max&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020-12-31&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;group_by_brand&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brand&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;sum_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;sum&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;total_sum_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;sum&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>需求8：查询某个品牌按颜色的销量</li></ul> <p>类似 sql <code>select count(*) from tvs where brand like '%小米%' group by color</code></p> <p>聚合都是在搜索的结果中进行的</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;brand&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;小米&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;group_by_color&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;color&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>需求9：单个品牌与所有品牌销量对比</li></ul> <p>第一个 <code>aggs</code> 下有两个自定义名称的嵌套</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;brand&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;小米&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;single_brand_avg_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;global&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;all_brand_avg_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>需求10：过滤+聚合，统计价格大于 1200 的电视平均价格</li></ul> <p>先将搜索的结果进行过滤后再聚合。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;constant_score&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;gte&quot;</span><span class="token operator">:</span> <span class="token number">1200</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;avg_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>需求11：统计每个品牌最近一个月的平均价格</li></ul> <p>在分组中过滤的好处：可有多个不同过滤的分组，第一个 <code>aggs</code> 中可有多个自定义命名的嵌套。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;recent_150d&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;sold_date&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;gte&quot;</span><span class="token operator">:</span> <span class="token string">&quot;now-150d&quot;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;group_by_brand&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brand&quot;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;avg_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                            <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                                <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查询某个品牌</span>
<span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;brand&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;小米&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><ul><li>需求12：每种颜色的平均销售额降序排序</li></ul> <p>相当于sql子表数据字段可以立刻使用</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;group_by_color&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">,</span>
        <span class="token comment">// 升序</span>
        <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;avg_price&quot;</span><span class="token operator">:</span> <span class="token string">&quot;asc&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;avg_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>需求13：按照每种颜色的每种品牌平均销售额降序排序</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;group_by_color&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;color&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;group_by_brand&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brand&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                            <span class="token property">&quot;avg_price&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;avg_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                            <span class="token comment">// 平均值关键词</span>
                            <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                                <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="java-api-聚合"><a href="#java-api-聚合" class="header-anchor">#</a> java api 聚合</h2> <ol><li>构建请求
<ul><li>SearchRequest</li> <li>SearchSourceBuilder</li> <li>TermsAggregation</li></ul></li> <li>执行请求</li> <li>获取结果</li></ol> <p>需求一：按颜色分组，计算每个颜色卖出的个数</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//1 构建请求</span>
<span class="token class-name">SearchRequest</span> searchRequest<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;tvs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//请求体</span>
<span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
searchSourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">TermsAggregationBuilder</span> termsAggregationBuilder <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;group_by_color&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;color&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
searchSourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>termsAggregationBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//请求体放入请求头</span>
searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//2 执行</span>
<span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//3 获取结果</span>
<span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Terms</span> group_by_color <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;group_by_color&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">&gt;</span></span> buckets <span class="token operator">=</span> group_by_color<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;key:&quot;</span><span class="token operator">+</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">long</span> docCount <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getDocCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;docCount:&quot;</span><span class="token operator">+</span>docCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=================================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>需求二：按颜色分组的每组平均价格</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//terms聚合下填充一个子聚合</span>
<span class="token class-name">AvgAggregationBuilder</span> avgAggregationBuilder <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">&quot;avg_price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
termsAggregationBuilder<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>avgAggregationBuilder<span class="token punctuation">)</span>
</code></pre></div><p>需求三：按颜色分组，每个颜色卖出个数、平均值、最大最小值</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//termsAggregationBuilder里放入多个子聚合</span>
<span class="token class-name">AvgAggregationBuilder</span> avgAggregationBuilder <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">&quot;avg_price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

termsAggregationBuilder<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>avgAggregationBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>需求四：价格区间 histogram 销售总额</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">HistogramAggregationBuilder</span> histogramAggregationBuilder <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">histogram</span><span class="token punctuation">(</span><span class="token string">&quot;by_histogram&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">SumAggregationBuilder</span> sumAggregationBuilder <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">&quot;income&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
histogramAggregationBuilder<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>sumAggregationBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>需求五：计算每个季度的销售总额</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">DateHistogramAggregationBuilder</span> dateHistogramAggregationBuilder <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">dateHistogram</span><span class="token punctuation">(</span><span class="token string">&quot;date_histogram&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;sold_date&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">calendarInterval</span><span class="token punctuation">(</span><span class="token class-name">DateHistogramInterval</span><span class="token punctuation">.</span><span class="token constant">QUARTER</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">minDocCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">extendedBounds</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExtendedBounds</span><span class="token punctuation">(</span><span class="token string">&quot;2019-01-01&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2020-12-31&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SumAggregationBuilder</span> sumAggregationBuilder <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">&quot;income&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dateHistogramAggregationBuilder<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>sumAggregationBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

searchSourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>dateHistogramAggregationBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="es7-sql"><a href="#es7-sql" class="header-anchor">#</a> es7 sql</h2> <p>需求：按照颜色分组，计算每个颜色卖出的电视的数量、平均值、最大最小值。</p> <div class="language-mysql extra-class"><pre class="language-text"><code>select color,count(color), avg(price), min(price), max(price), sum(price) from tvs group by color
</code></pre></div><p><strong>es 使用 sql 语句</strong></p> <div class="language-json extra-class"><pre class="language-json"><code>POST /_sql?format=txt
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SELECT * FROM tvs &quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 计算每个颜色卖出的电视的数量、平均值、最大最小值</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;select color,count(color), avg(price), min(price), max(price), sum(price) from tvs group by color&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>sql 启动方式</strong></p> <ol><li>http 请求</li> <li>客户端 <code>sql-cli.bat</code></li> <li>代码</li></ol> <p><strong>响应格式</strong></p> <p><code>/_sql?format=</code></p> <p>csv / json / txt / yaml</p> <p><strong>查看 sql 翻译成 DSL 请求</strong></p> <div class="language-json extra-class"><pre class="language-json"><code>POST /_sql/translate
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SELECT * FROM tvs &quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>DSL 与 sql 结合</strong></p> <div class="language-json extra-class"><pre class="language-json"><code>POST /_sql?format=txt
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SELECT * FROM tvs&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;gte&quot;</span> <span class="token operator">:</span> <span class="token number">1200</span><span class="token punctuation">,</span>
                <span class="token property">&quot;lte&quot;</span> <span class="token operator">:</span> <span class="token number">2000</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="logstash"><a href="#logstash" class="header-anchor">#</a> Logstash</h2> <h3 id="基础"><a href="#基础" class="header-anchor">#</a> 基础</h3> <p>数据抽取工具，通过输入插件获取数据、过滤插件进行数据转换、输出插件提供数据给 es。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>logstash.bat <span class="token parameter variable">-f</span> <span class="token punctuation">..</span>/config/test.conf
</code></pre></div><p>🟠<strong>都需要安装相应插件</strong></p> <p><strong>读取</strong></p> <div class="language-conf extra-class"><pre class="language-text"><code>// 标准输入
input{
    stdin{
       
    }
}

// 读取文件 会监听文件变化
input {
    file {
        path =&gt; [&quot;/var/*/*&quot;]
        start_position =&gt; &quot;beginning&quot;
    }
}

// TCP网络
input {
  tcp {
    port =&gt; &quot;1234&quot;
  }
}

// 标准输出
output {
    stdout{
        codec=&gt;rubydebug
    }
}
</code></pre></div><p><strong>过滤</strong></p> <ol><li>正则捕获、移除字段</li> <li>时间处理</li> <li>数据修改：替换、分割、重命名、删除字段</li></ol> <div class="language-conf extra-class"><pre class="language-text"><code>input {
    stdin {}
}
filter {
    grok {
        match =&gt; { &quot;message&quot; =&gt; &quot;%{IP:clientip}\ \[%{HTTPDATE:timestamp}\]\ %{QS:referrer}\ %{NUMBER:response}\ %{NUMBER:bytes}&quot; }
        remove_field =&gt; [ &quot;message&quot; ]
   }
date {
        match =&gt; [&quot;timestamp&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]
    }
mutate {
          convert =&gt; [ &quot;response&quot;,&quot;float&quot; ]
           rename =&gt; { &quot;response&quot; =&gt; &quot;response_new&quot; }   
           gsub =&gt; [&quot;referrer&quot;,&quot;\&quot;&quot;,&quot;&quot;]          
           split =&gt; [&quot;clientip&quot;, &quot;.&quot;]
        }
}
output {
    stdout {
        codec =&gt; &quot;rubydebug&quot;
    }
}
</code></pre></div><p><strong>输出</strong></p> <div class="language-conf extra-class"><pre class="language-text"><code>// 标注输出
output {
    stdout {
        codec =&gt; rubydebug
    }
}

// 保存为文件
output {
    file {
        path =&gt; &quot;/data/log/%{+yyyy-MM-dd}/%{host}_%{+HH}.log&quot;
    }
}

// 输出到 elasticsearch
output {
    elasticsearch {
        host =&gt; [&quot;192.168.1.1:9200&quot;,&quot;172.16.213.77:9200&quot;]
        index =&gt; &quot;logstash-%{+YYYY.MM.dd}&quot;       
    }
}
</code></pre></div><p>输出到 elasticsearch：</p> <ul><li>host 端口数组</li> <li>index 写入elasticsearch的索引的名称</li></ul> <h3 id="读取-nginx-日志"><a href="#读取-nginx-日志" class="header-anchor">#</a> 读取 nginx 日志</h3> <div class="language-conf extra-class"><pre class="language-text"><code>input {
    file {
        path =&gt; [&quot;D:/ES/logstash-7.3.0/nginx.log&quot;]        
        start_position =&gt; &quot;beginning&quot;
    }
}

filter {
    grok {
        match =&gt; { &quot;message&quot; =&gt; &quot;%{IP:clientip}\ \[%{HTTPDATE:timestamp}\]\ %{QS:referrer}\ %{NUMBER:response}\ %{NUMBER:bytes}&quot; }
        remove_field =&gt; [ &quot;message&quot; ]
   }
	date {
        match =&gt; [&quot;timestamp&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]
    }
	mutate {
           rename =&gt; { &quot;response&quot; =&gt; &quot;response_new&quot; }
           convert =&gt; [ &quot;response&quot;,&quot;float&quot; ]
           gsub =&gt; [&quot;referrer&quot;,&quot;\&quot;&quot;,&quot;&quot;]
           remove_field =&gt; [&quot;timestamp&quot;]
           split =&gt; [&quot;clientip&quot;, &quot;.&quot;]
        }
}

output {
    stdout {
        codec =&gt; &quot;rubydebug&quot;
    }

elasticsearch {
    host =&gt; [&quot;localhost:9200&quot;]
    index =&gt; &quot;logstash-%{+YYYY.MM.dd}&quot;       
}

}
</code></pre></div><h2 id="kibana"><a href="#kibana" class="header-anchor">#</a> Kibana</h2> <p>功能：</p> <ol><li>基本查询</li> <li>可视化（时序图、饼状图、数据表）</li> <li>仪表盘：添加视图，参考样例数据的可视图</li> <li>开发工具：Grok Debugger</li> <li>堆栈监测</li></ol> <h2 id="集群部署"><a href="#集群部署" class="header-anchor">#</a> 集群部署</h2> <p>节点角色：</p> <ul><li>主结点：集群的管理、索引的管理</li> <li>数据结点：保存数据分片，负责索引和搜索操作</li> <li>客户端结点：负载均衡器，将请求转发给其他结点</li></ul> <p>elasticsearch 配置文件：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">node.master</span><span class="token punctuation">:</span> <span class="token comment">#是否允许为主结点</span>
<span class="token key atrule">node.data</span><span class="token punctuation">:</span> <span class="token comment">#允许存储数据作为数据结点</span>
<span class="token key atrule">node.ingest</span><span class="token punctuation">:</span> <span class="token comment">#是否允许成为协调节点</span>
</code></pre></div><p>四种组合方式：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>master=true，data=true：即是主结点又是数据结点
master=false，data=true：仅是数据结点
master=true，data=false：仅是主结点，不存储数据
master=false，data=false：即不是主结点也不是数据结点，此时可设置ingest为true表示它是一个客户端。
</code></pre></div><p><strong>架构</strong></p> <ul><li>在服务模块、日志、数据库上使用 logstash 收集数据发送到 es 集群</li> <li>kibana 连接 es 协调节点</li> <li>搜索模块通过代码向 es 协调节点查询</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/Nova-mist/HexoBlogResources/images/2022/202210161912190.png" alt="image-20221016191241897"></p> <h2 id="todo-8-4-java-api"><a href="#todo-8-4-java-api" class="header-anchor">#</a> TODO：8.4 java api</h2> <h2 id="todo-项目实战"><a href="#todo-项目实战" class="header-anchor">#</a> TODO：项目实战</h2> <p><a href="https://www.ydlclass.com/doc21xnv/distribute/elk/elk2.html#%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%B8%89%E7%AB%A0-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98" target="_blank" rel="noopener noreferrer">文档合集 (ydlclass.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/8/2022, 2:56:58 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/NovaBlog/%E4%B8%AD%E9%97%B4%E4%BB%B6/ELK/" class="prev router-link-active">
        ELK
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/NovaBlog/assets/js/app.7283b6f5.js" defer></script><script src="/NovaBlog/assets/js/2.6539ea43.js" defer></script><script src="/NovaBlog/assets/js/55.4577ea3a.js" defer></script>
  </body>
</html>
